version: "3.9"

services:
  # -------------------------
  # Database Service (MySQL)
  # -------------------------
  paymybuddy-db:
    image: mysql:8.0.33                       # Use official MySQL 8.0 image
    container_name: paymybuddy-db             # Container name
    restart: unless-stopped                    # Restart automatically unless explicitly stopped
    environment:                              
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}  # Root password from .env
      MYSQL_DATABASE: ${MYSQL_DATABASE}           # Database name from .env
      MYSQL_USER: ${MYSQL_USER}                   # Application user from .env
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}           # User password from .env
    ports:
      - "${MYSQL_PORT}:3306"                     # Expose MySQL to host for testing/debug
    volumes:
      - db-data:/var/lib/mysql                   # Persist MySQL data across container restarts
      - ./initdb:/docker-entrypoint-initdb.d    # Optional: run initialization scripts on startup
    healthcheck:                                # Ensure DB is ready before backend starts
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # -------------------------
  # Backend Service (Spring Boot)
  # -------------------------
  paymybuddy-backend:
    build: .                                    # Build image from local Dockerfile
    container_name: paymybuddy-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT}:8080"                  # Expose backend on host
    environment:                                # Inject Spring Boot environment variables
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL}
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: ${SPRING_JPA_HIBERNATE_DDL_AUTO}
      SPRING_JPA_SHOW_SQL: ${SPRING_JPA_SHOW_SQL}
    depends_on:                                 # Ensure DB is healthy before starting backend
      paymybuddy-db:
        condition: service_healthy

  # -------------------------
  # Local Docker Registry
  # -------------------------
  paymybuddy-registry:
    image: registry:2                           # Official Docker Registry image
    container_name: paymybuddy-registry
    restart: unless-stopped
    ports:
      - "${REGISTRY_PORT}:5000"                 # Expose registry API on host
    volumes:
      - registry-data:/var/lib/registry         # Persist registry storage across restarts

# -------------------------
# Persistent Volumes
# -------------------------
volumes:
  db-data:                                      # MySQL data volume
  registry-data:                                # Registry storage volume
