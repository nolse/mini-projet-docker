version: "3.9"

services:
  # -------------------------
  # Database Service (MySQL)
  # -------------------------
  paymybuddy-db:
    image: mysql:8.0.33                   # Stable MySQL version compatible with most CPUs
    container_name: paymybuddy-db         # Container name
    restart: unless-stopped                # Automatically restart unless explicitly stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword   # Root password
      MYSQL_DATABASE: paymybuddy          # Database name
      MYSQL_USER: paymybuddy_user         # Application user
      MYSQL_PASSWORD: supersecret         # User password
    ports:
      - "3306:3306"                       # Expose MySQL for local testing
    volumes:
      - db-data:/var/lib/mysql             # Persistent volume to keep MySQL data
      - ./initdb:/docker-entrypoint-initdb.d  # Optional initialization scripts
    healthcheck:                          # Checks if the database is ready before backend starts
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # -------------------------
  # Backend Service (Spring Boot)
  # -------------------------
  paymybuddy-backend:
    build: .                              # Build image from Dockerfile in current directory
    container_name: paymybuddy-backend    # Backend container name
    restart: unless-stopped                # Automatically restart if stopped
    ports:
      - "8080:8080"                        # Expose backend on port 8080
    environment:                            # Spring Boot environment variables for MySQL connection
      SPRING_DATASOURCE_URL: jdbc:mysql://paymybuddy-db:3306/paymybuddy?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      SPRING_DATASOURCE_USERNAME: paymybuddy_user
      SPRING_DATASOURCE_PASSWORD: supersecret
      SPRING_JPA_HIBERNATE_DDL_AUTO: update # Hibernate automatically creates or updates schema
      SPRING_JPA_SHOW_SQL: "true"          # Show SQL queries in logs
    depends_on:                             # Backend waits for DB to be healthy before starting
      paymybuddy-db:
        condition: service_healthy

  # -------------------------
  # Local Docker Registry
  # -------------------------
  paymybuddy-registry:
    image: registry:2                      # Official Docker Registry image
    container_name: paymybuddy-registry
    restart: unless-stopped
    ports:
      - "5000:5000"                        # Port to access local registry
    volumes:
      - registry-data:/var/lib/registry    # Persistent storage for pushed images

# -------------------------
# Persistent Volumes
# -------------------------
volumes:
  db-data:                                  # Keep MySQL data between restarts
  registry-data:                            # Keep images in the local registry
